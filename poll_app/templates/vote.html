<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>


</head>
<body class="bg-white text-[#151a37] font-sans">

  <div class="flex ">



<div id="sidebar" class="fixed top-0 left-0 h-full w-64 bg-[#06038D] text-white p-6 z-50 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out">
  <div class="flex items-center justify-between mb-6">
    <div class="w-full bg-white flex justify-center pl-10">
<a href="index.html" id="brand" class="transition-all block">
      <h1 class="mt-2 text-lg md:text-xl md:mt-0 uppercase font-bold text-[#06038D]">Tamil Nadu Polling 2026</h1>

    </a>    </div>
    <button onclick="toggleSidebar()" class="md:hidden text-white text-2xl">&times;</button>
  </div>
   <nav>
    <ul class="space-y-4 text-sm">
      <li>
        <a href="{% url 'dashboard' %}"  class="block py-2 px-4 rounded hover:bg-white hover:text-[#151a37]">Dashboard</a>
      </li>
        <li>
        <a href="{% url 'admin_party' %}" class="block py-2 px-4 rounded hover:bg-white hover:text-[#151a37]">Party</a>
      </li>
        <a href="{% url 'candidates' %}" class="block py-2 px-4 rounded hover:bg-white hover:text-[#151a37]" >Candidates</a>
      </li>
       <li>
        <a href="{% url 'opinion' %}" class="block py-2 px-4 rounded hover:bg-white hover:text-[#151a37]">Public Opinions</a>
      </li>
      <li>
        <a href="{% url 'admin_news' %}" class="block py-2 px-4 rounded hover:bg-white hover:text-[#151a37]" >News</a>
      </li>
       <li>
        <a href="{% url 'admin_blog' %}" class="block py-2 px-4 rounded hover:bg-white hover:text-[#151a37]">Blogs</a>
      </li>
      <li>
        <a href="{% url 'admin_contact' %}" class="block py-2 px-4 rounded hover:bg-white hover:text-[#151a37]">Contact Form </a>
      </li>
        <li>
        <a href="{% url 'vote_analysis' %}" class="block py-2 px-4 rounded bg-white text-[#151a37]">Votes</a>
      </li>
      <li>
        <a href="{% url 'logout' %}" class="block py-2 px-4 rounded bg-[red] text-white">Logout</a>
      </li>
    </ul>

   </nav>

</div>
<button onclick="toggleSidebar()" class="md:hidden fixed top-4 left-4 z-50 bg-[#06038D] text-white p-2 rounded shadow-lg">
  &#9776;
</button>




<!-- âœ… Chart.js & Export Libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<section class="px-6 md:px-20 py-10 md:ml-64 w-full">

  <!-- ðŸ“„ Download Report Button -->
  <div class="flex justify-end mb-6 md:ml-64 mr-10">
    <button id="downloadPdfBtn"
            class="bg-[#06038D] text-white px-4 py-2 rounded shadow hover:bg-[#0a0fbf] transition">
      ðŸ“„ Download Full Report
    </button>
  </div>

  <!-- ðŸŸ¦ Overall Bar Graphs -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-6xl mx-auto mb-10">
    <div class="bg-white shadow-lg rounded-lg p-6">
      <h2 class="text-xl font-semibold text-gray-800 mb-4 text-center">Total Votes by Party</h2>
      <canvas id="partyVotesChart" height="250"></canvas>
    </div>
    <div class="bg-white shadow-lg rounded-lg p-6">
      <h2 class="text-xl font-semibold text-gray-800 mb-4 text-center">Total Votes by Aligned Party</h2>
      <canvas id="alignedVotesChart" height="250"></canvas>
    </div>
  </div>

  <!-- ðŸŸ£ District Dropdown -->
  <div class="text-center mb-8">
    <label class="font-semibold text-lg text-gray-700 mr-2">District:</label>
    <select id="districtSelect" class="border border-gray-300 rounded px-3 py-2">
      {% for d in districts %}
        <option value="{{ d.id }}" {% if d.id == selected_district %}selected{% endif %}>{{ d.name }}</option>
      {% endfor %}
    </select>
  </div>

  <!-- ðŸŸ£ District Pie Charts -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-6xl mx-auto mb-10">
    <div class="bg-white shadow-lg rounded-lg p-6">
      <h2 class="text-xl font-semibold text-gray-800 mb-4 text-center">District-wise Party Vote Share</h2>
      <canvas id="districtPartyPie" height="250"></canvas>
      <p id="partyLeader" class="text-center text-green-600 mt-3 font-semibold"></p>
    </div>
    <div class="bg-white shadow-lg rounded-lg p-6">
      <h2 class="text-xl font-semibold text-gray-800 mb-4 text-center">District-wise Aligned Party Vote Share</h2>
      <canvas id="districtAlignedPie" height="250"></canvas>
      <p id="alignedLeader" class="text-center text-green-600 mt-3 font-semibold"></p>
    </div>
  </div>

  <!-- ðŸŸ¢ Constituency Dropdown -->
  <div class="text-center mb-8">
    <label class="font-semibold text-lg text-gray-700 mr-2">Constituency:</label>
    <select id="constituencySelect" class="border border-gray-300 rounded px-3 py-2">
      {% for c in constituencies %}
        <option value="{{ c.id }}" {% if c.id == selected_constituency %}selected{% endif %}>{{ c.name }}</option>
      {% endfor %}
    </select>
  </div>

  <!-- ðŸŸ¢ Constituency Pie Charts -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-6xl mx-auto">
    <div class="bg-white shadow-lg rounded-lg p-6">
      <h2 class="text-xl font-semibold text-gray-800 mb-4 text-center">Constituency-wise Party Vote Share</h2>
      <canvas id="constituencyPartyPie" height="250"></canvas>
      <p id="constituencyPartyLeader" class="text-center text-green-600 mt-3 font-semibold"></p>
    </div>
    <div class="bg-white shadow-lg rounded-lg p-6">
      <h2 class="text-xl font-semibold text-gray-800 mb-4 text-center">Constituency-wise Aligned Party Vote Share</h2>
      <canvas id="constituencyAlignedPie" height="250"></canvas>
      <p id="constituencyAlignedLeader" class="text-center text-green-600 mt-3 font-semibold"></p>
    </div>
  </div>
</section>

<script>
const getColors = (n) => Array.from({length: n}, (_, i) => `hsl(${(i*47)%360},70%,55%)`);

const partyData = JSON.parse(`{{ party_votes|safe }}`);
const alignedData = JSON.parse(`{{ aligned_votes|safe }}`);
let districtPartyData = JSON.parse(`{{ district_party_votes|safe }}`);
let districtAlignedData = JSON.parse(`{{ district_aligned_votes|safe }}`);
let constituencyPartyData = JSON.parse(`{{ constituency_party_votes|safe }}`);
let constituencyAlignedData = JSON.parse(`{{ constituency_aligned_votes|safe }}`);

// === Utility for Updating Charts ===
function updateChart(chart, newData, leaderId) {
  chart.data.labels = newData.map(d => d.name);
  chart.data.datasets[0].data = newData.map(d => d.vote_count);
  chart.data.datasets[0].backgroundColor = getColors(newData.length);
  chart.update();

  const leader = newData.reduce((max, d) => d.vote_count > (max?.vote_count||0)? d : max, null);
  document.getElementById(leaderId).textContent = leader && leader.vote_count > 0
    ? ` Leading: ${leader.name} (${leader.vote_count} votes)`
    : "No votes yet.";
}

// === Bar Charts ===
new Chart(document.getElementById("partyVotesChart"), {
  type: "bar",
  data: { labels: partyData.map(p=>p.name), datasets:[{label:"Votes", data:partyData.map(p=>p.vote_count), backgroundColor:"#3B82F6"}] },
  options: { plugins: {legend:{display:false}} }
});
new Chart(document.getElementById("alignedVotesChart"), {
  type: "bar",
  data: { labels: alignedData.map(a=>a.name), datasets:[{label:"Votes", data:alignedData.map(a=>a.vote_count), backgroundColor:"#10B981"}] },
  options: { plugins: {legend:{display:false}} }
});

// === Pie Charts ===
const makePie = (id, data) => new Chart(document.getElementById(id), {
  type: "pie",
  data: { labels: data.map(d=>d.name), datasets:[{data:data.map(d=>d.vote_count), backgroundColor:getColors(data.length)}]},
  options: { plugins:{tooltip:{callbacks:{label:(ctx)=>`${ctx.label}: ${ctx.raw} (${((ctx.raw/ctx.dataset.data.reduce((a,b)=>a+b,0))*100).toFixed(1)}%)`}}, legend:{position:"bottom"}} }
});

const districtPartyPie = makePie("districtPartyPie", districtPartyData);
const districtAlignedPie = makePie("districtAlignedPie", districtAlignedData);
const constituencyPartyPie = makePie("constituencyPartyPie", constituencyPartyData);
const constituencyAlignedPie = makePie("constituencyAlignedPie", constituencyAlignedData);

// === District Change ===
document.getElementById("districtSelect").addEventListener("change", function() {
  fetch(`?district=${this.value}`, {headers:{'X-Requested-With':'XMLHttpRequest'}})
    .then(res=>res.json())
    .then(data=>{
      updateChart(districtPartyPie, data.district_party_votes, "partyLeader");
      updateChart(districtAlignedPie, data.district_aligned_votes, "alignedLeader");

      const constituencySelect = document.getElementById("constituencySelect");
      constituencySelect.innerHTML = data.constituencies.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
      constituencySelect.dispatchEvent(new Event('change'));
    });
});

// === Constituency Change ===
document.getElementById("constituencySelect").addEventListener("change", function() {
  fetch(`?constituency=${this.value}`, {headers:{'X-Requested-With':'XMLHttpRequest'}})
    .then(res=>res.json())
    .then(data=>{
      updateChart(constituencyPartyPie, data.constituency_party_votes, "constituencyPartyLeader");
      updateChart(constituencyAlignedPie, data.constituency_aligned_votes, "constituencyAlignedLeader");
    });
});

// === ðŸ“„ Export to PDF ===
document.getElementById("downloadPdfBtn").addEventListener("click", async () => {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p", "mm", "a4");
  const charts = [
    { title: "Total Votes by Party", id: "partyVotesChart" },
    { title: "Total Votes by Aligned Party", id: "alignedVotesChart" },
    { title: "District-wise Party Vote Share", id: "districtPartyPie" },
    { title: "District-wise Aligned Party Vote Share", id: "districtAlignedPie" },
    { title: "Constituency-wise Party Vote Share", id: "constituencyPartyPie" },
    { title: "Constituency-wise Aligned Party Vote Share", id: "constituencyAlignedPie" }
  ];

  let y = 20;
  for (const chart of charts) {
    const canvas = document.getElementById(chart.id);
    if (!canvas) continue;

    const imgData = canvas.toDataURL("image/png", 1.0);
    pdf.setFontSize(16);
    pdf.text(chart.title, 10, y);
    y += 10;
    pdf.addImage(imgData, "PNG", 10, y, 180, 90);
    y += 100;

    if (y > 260) { pdf.addPage(); y = 20; }
  }

  pdf.save("Election_Vote_Analytics_Report.pdf");
});
</script>


<script src="./static/js/admin_scripts.js"></script>
</body>

</html>